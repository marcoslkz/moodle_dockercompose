# https://hub.docker.com/r/moodlehq/moodle-php-apache/
# set .env vars: DOMAIN_NAME , SITE_PATH

version: '3'

services:
  webserver:
    #image: moodlehq/moodle-php-apache:8.2-bullseye
    image: docker.io/bitnami/moodle:4.1
    container_name: "moodle_${SITE_PATH}"
    environment:
      - DOMAIN_NAME
      - SITE_PATH
      - PHP_MEMORY_LIMIT
      - PHP_POST_MAX_SIZE
      - PHP_UPLOAD_MAX_FILESIZE
      - MOODLE_HOST=${DOMAIN_NAME}
      - MOODLE_REVERSEPROXY=true
      - MOODLE_SSLPROXY=true
      - MOODLE_DATABASE_PORT_NUMBER=3306
      - MOODLE_DATABASE_USER
      - MOODLE_DATABASE_NAME=${SITE_PATH}
      - MOODLE_DATABASE_HOST
      - MOODLE_DATABASE_PASSWORD
      - MOODLE_SKIP_BOOTSTRAP=no
      - MOODLE_USERNAME
      - MOODLE_PASSWORD
      - MOODLE_EMAIL
      - MOODLE_LANG
    labels:
      - traefik.enable=true
      - traefik.http.services.moodle_${SITE_PATH}.loadbalancer.server.port=80
      - traefik.http.routers.moodle_${SITE_PATH}.tls.certresolver=letsencrypt
      - traefik.frontend.entryPoints=http,https
      - traefik.http.routers.moodle_${SITE_PATH}.rule=Host(`${DOMAIN_NAME}`) && ( PathPrefix(`/${SITE_PATH}`) )
      - traefik.http.middlewares.moodle_${SITE_PATH}.stripprefix.prefixes=/${SITE_PATH}    
      - traefik.http.middlewares.moodle_${SITE_PATH}.stripprefix.forceslash=true
      - traefik.http.routers.moodle_${SITE_PATH}.middlewares=moodle_${SITE_PATH}
    volumes:
      - 'moodledata:/bitnami/moodledata'
    restart: unless-stopped
    networks: 
      - proxy_default

volumes:
  moodledata:

networks:
  proxy_default:
    external: true
